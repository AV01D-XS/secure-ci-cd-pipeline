name: Secure CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

# Prevent multiple runs piling up for same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: payment-service
  IMAGE_TAG: ${{ github.sha }}

jobs:
  lint-and-test:
    name: Lint & Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          # cache pip for faster installs
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r src/app/requirements-dev.txt
          # Also install the app in editable mode for tests
          pip install -e src/app/

      - name: Run flake8
        run: |
          # We ignore E203,E501 - black handles formatting
          flake8 src --ignore=E203,E501 --max-complexity=10 || echo "##[warning]Linting issues found - will fix later"
        # Note: We don't fail the build on linting, just warn

      - name: Run bandit
        run: |
          # Skip some low confidence issues, exclude test files
          bandit -r src -x "*/test_*,*/tests/*" -ll || echo "##[warning]Security issues found, review needed"
        # Bandit findings don't fail the build either - we triage manually

      - name: Run unit tests with coverage
        run: |
          pytest -v --cov=src --cov-report=xml --cov-fail-under=80
        env:
          TEST_DB_URL: sqlite:///:memory:

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
        # We don't fail if codecov is down

  secret-scan:
    name: Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history for gitleaks)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # needed for gitleaks to scan commits

      - name: Run gitleaks
        uses: zricethezav/gitleaks-action@v2
        with:
          args: detect --verbose --redact
        # This one we DO fail on - secrets in code are critical
        continue-on-error: false

  sast-scan:
    name: SAST Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Semgrep
        run: |
          # Using our custom config that ignores some false positives
          docker run -v $(pwd):/src returntocorp/semgrep:latest semgrep scan \
            --config=/src/.semgrep.yml \
            --json --output semgrep-results.json \
            --error || echo "Semgrep completed with findings"
        # We have a .semgrep.yml config that excludes vendored code

      - name: Upload semgrep results
        if: always()
        uses: actions/upload-artifact@v3  # Note: using v3, we haven't updated this one yet
        with:
          name: semgrep-results-${{ github.sha }}
          path: semgrep-results.json
          retention-days: 30

  build-and-scan:
    name: Build & Security Scan
    runs-on: ubuntu-latest
    needs: [lint-and-test, secret-scan]  # Don't wait for SAST which can be slow
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
        with:
          driver-opts: |
            image=moby/buildkit:buildx-stable-1

      - name: Build container image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: Dockerfile
          load: true  # Keep locally for scanning
          tags: ${{ env.APP_NAME }}:${{ env.IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # Using GitHub's cache for build layers

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@v0.14.0  # Pinned to older version that we trust
        with:
          image-ref: ${{ env.APP_NAME }}:${{ env.IMAGE_TAG }}
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH  # Only fail on high+ severity

      - name: Upload Trivy results
        uses: actions/upload-artifact@v3
        with:
          name: trivy-results
          path: trivy-results.sarif

      - name: Fail if critical vulnerabilities found
        if: steps.trivy.outputs.exit-code != 0
        run: |
          echo "âŒ Critical vulnerabilities found - check Trivy report"
          echo "Some may be false positives - see internal wiki for exemption process"
          exit 1

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build-and-scan
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run integration tests
        run: |
          docker run --network host \
            -e DATABASE_URL=postgresql://postgres:postgres@localhost:5432/test_db \
            ${{ env.APP_NAME }}:${{ env.IMAGE_TAG }} \
            pytest tests/integration/ -v

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-and-scan, integration-tests]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    environment: 
      name: staging
      url: https://staging-payments.example.com
    
    steps:
      - name: Deploy to Kubernetes
        run: |
          # Using our custom deployment script
          ./scripts/deploy.sh staging ${{ env.IMAGE_TAG }}
        env:
          KUBECONFIG: ${{ secrets.STAGING_KUBECONFIG }}

      - name: Smoke test
        run: |
          ./scripts/smoke-test.sh https://staging-payments.example.com/health

  security-dashboard:
    name: Update Security Dashboard
    runs-on: ubuntu-latest
    needs: [sast-scan, build-and-scan]
    if: always()  # Run even if previous jobs failed
    steps:
      - name: Download scan results
        uses: actions/download-artifact@v3
        with:
          path: /tmp/artifacts

      - name: Parse and report metrics
        run: |
          python scripts/security_metrics.py \
            --semgrep /tmp/artifacts/semgrep-results-*/semgrep-results.json \
            --trivy /tmp/artifacts/trivy-results/trivy-results.sarif \
            --output security-report.json
        # This script posts to our internal security dashboard

      - name: Upload security report
        uses: actions/upload-artifact@v3
        with:
          name: security-report
          path: security-report.json
          retention-days: 90
